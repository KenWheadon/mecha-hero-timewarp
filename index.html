<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mecha Hero - Mini Jam 197: Recursion</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000;
        color: #fff;
        font-family: monospace;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
      }
      #title-screen {
        text-align: center;
        max-width: 800px;
      }
      #title {
        font-size: 48px;
        margin-bottom: 40px;
        text-shadow: 0 0 10px #0f0;
      }
      .title-btn {
        padding: 15px 30px;
        font-size: 24px;
        background: #333;
        border: 2px solid #fff;
        color: #fff;
        cursor: pointer;
        margin: 10px;
        transition: background 0.2s;
      }
      .title-btn:hover {
        background: #555;
      }
      #game {
        text-align: center;
        max-width: 800px;
        display: none; /* Hidden until start */
      }
      #controls {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
      }
      #pause {
        padding: 10px 20px;
        background: #f00;
        border: none;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
      }
      #hearts {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        gap: 10px;
      }
      .heart {
        width: 40px;
        height: 40px;
      }
      #fight-info {
        position: absolute;
        top: 80px;
        right: 20px;
        font-size: 24px;
      }
      #timer {
        width: 200px;
        height: 20px;
        background: #333;
        margin: 20px auto;
        border: 2px solid #fff;
        position: relative;
      }
      #timer-fill {
        height: 100%;
        background: #0f0;
        width: 100%;
        transition: width 0.1s;
      }
      #timer-paused {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        color: #ff0;
        font-size: 12px;
        display: none;
      }
      #enemy-pose {
        width: 300px;
        height: 300px;
        margin: 20px auto;
        border: 2px solid #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        background: #111;
      }
      #pose-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      #instruction {
        font-size: 28px;
        font-weight: bold;
        margin: 20px;
        color: #0f0;
        min-height: 40px;
      }
      #attacks {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        max-width: 400px;
        margin: 20px auto;
      }
      .attack-btn {
        padding: 20px;
        font-size: 18px;
        background: #333;
        border: 2px solid #fff;
        color: #fff;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 80px;
      }
      .attack-btn img {
        width: 60px;
        height: 60px;
        object-fit: contain;
        margin-right: 10px;
      }
      .attack-btn:hover:not(:disabled) {
        background: #555;
      }
      .attack-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
      #message {
        font-size: 20px;
        margin: 20px;
        min-height: 25px;
      }
      #restart {
        display: none;
        padding: 10px 20px;
        background: #f00;
        border: none;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        margin-top: 20px;
      }
      #how-to-play {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #111;
        border: 2px solid #fff;
        padding: 20px;
        max-width: 500px;
        z-index: 10;
      }
      #how-to-play h2 {
        margin-top: 0;
      }
      #how-to-play ul {
        text-align: left;
      }
      #close-htp {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
      }
      #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 5;
      }
    </style>
  </head>
  <body>
    <div id="overlay"></div>
    <div id="how-to-play">
      <button id="close-htp">&times;</button>
      <h2>How to Play Mecha Hero</h2>
      <p>
        Enter the recursive arena and counter the enemy's mecha poses before
        time runs out!
      </p>
      <ul>
        <li>
          <strong>Poses:</strong> Watch the enemy shift from neutral to attack
          stances. Fight 1: 2 poses/attacks. Fights 2-3: 4 poses/attacks (faster
          in 3).
        </li>
        <li>
          <strong>Respond:</strong> Click the correct counter (Shield Bash for
          high arms, Rocket Fist for low sweeps, etc.) within the timer.
        </li>
        <li>
          <strong>Timer:</strong> Green bar drains—timeout loses a heart.
          Correct hits advance; wrong retries after cooldown.
        </li>
        <li><strong>Hearts:</strong> 3 lives total. Lose all? Game over.</li>
        <li>
          <strong>Fights:</strong> Beat all poses to win a fight. Clear all 3
          fights to shatter the time crystal!
        </li>
        <li><strong>Pause:</strong> Hit pause to freeze the action anytime.</li>
      </ul>
      <p>Recursion rules: Patterns echo and accelerate—adapt or overload!</p>
    </div>

    <div id="title-screen">
      <h1 id="title">MECHA HERO</h1>
      <p>Recursion Jam Edition</p>
      <button class="title-btn" id="start-btn">Start Game</button>
      <button class="title-btn" id="htp-btn">How to Play</button>
    </div>

    <div id="game">
      <div id="controls">
        <button id="pause">Pause</button>
      </div>
      <div id="hearts"></div>
      <div id="fight-info">Fight: 1/3</div>
      <div id="timer">
        <div id="timer-paused">PAUSED</div>
        <div id="timer-fill"></div>
      </div>
      <div id="enemy-pose">
        <img
          id="pose-img"
          src="images/pose1.png"
          alt="Enemy Pose"
          onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTExIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5OZXV0cmFsIFN0YW5jZTwvdGV4dD48L3N2Zz4='"
        />
      </div>
      <div id="instruction">Prepare for battle...</div>
      <div id="message"></div>
      <div id="attacks">
        <button class="attack-btn" data-action="shield">
          <img
            src="images/shield.png"
            alt="Shield"
            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNmZmYiLz48L3N2Zz4='"
          />
          Shield Bash
        </button>
        <button class="attack-btn" data-action="rocket">
          <img
            src="images/rocket.png"
            alt="Rocket"
            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNmZjAiLz48L3N2Zz4='"
          />
          Rocket Fist
        </button>
        <button class="attack-btn" data-action="sword">
          <img
            src="images/sword.png"
            alt="Sword"
            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNmY2MiLz48L3N2Zz4='"
          />
          Sword Slash
        </button>
        <button class="attack-btn" data-action="plasma">
          <img
            src="images/plasma.png"
            alt="Plasma"
            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiMwMGZmIi8+PC9zdmc+';"
          />
          Plasma Dodge
        </button>
      </div>
      <button id="restart">Restart Game</button>
    </div>

    <script>
      // Game data - Neutral (1) as default/reset, Attacks (2-5) shuffled, Defeated (6) for win
      const neutralPose = {
        id: 1,
        desc: "Neutral Stance",
        img: "images/pose1.png",
      };
      const attackPoses = [
        {
          id: 2,
          desc: "Arm Cocked High",
          img: "images/pose2.png",
          correct: "shield",
        },
        {
          id: 3,
          desc: "Leg Sweep Low",
          img: "images/pose3.png",
          correct: "rocket",
        },
        {
          id: 4,
          desc: "Torso Twist",
          img: "images/pose4.png",
          correct: "sword",
        },
        {
          id: 5,
          desc: "Chest Burst",
          img: "images/pose5.png",
          correct: "plasma",
        },
      ];
      const defeatedPose = { id: 6, desc: "Defeated", img: "images/pose6.png" };

      let gameState = {
        currentFight: 1,
        maxFights: 3,
        hearts: 3,
        currentPoseIndex: 0,
        currentPoses: [], // Shuffled attacks only
        numPoses: 0,
        availableAttacks: [],
        timer: null,
        timerInterval: null,
        baseTimerDuration: 5000, // ms, adjusted per fight
        isPaused: false,
      };

      const elements = {
        titleScreen: document.getElementById("title-screen"),
        game: document.getElementById("game"),
        overlay: document.getElementById("overlay"),
        htp: document.getElementById("how-to-play"),
        closeHtp: document.getElementById("close-htp"),
        startBtn: document.getElementById("start-btn"),
        htpBtn: document.getElementById("htp-btn"),
        pause: document.getElementById("pause"),
        hearts: document.getElementById("hearts"),
        fightInfo: document.getElementById("fight-info"),
        timerFill: document.getElementById("timer-fill"),
        timerPaused: document.getElementById("timer-paused"),
        poseImg: document.getElementById("pose-img"),
        instruction: document.getElementById("instruction"),
        message: document.getElementById("message"),
        attacks: document.querySelectorAll(".attack-btn"),
        restart: document.getElementById("restart"),
      };

      // Set pose image
      function setPose(pose) {
        elements.poseImg.src = pose.img;
        elements.poseImg.onerror = () => {
          const fallbackText = pose.desc || "Unknown Pose";
          elements.poseImg.src =
            "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTExIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj4=" +
            encodeURIComponent(fallbackText) +
            "</text></svg>";
        };
      }

      // Init hearts
      function initHearts() {
        elements.hearts.innerHTML = "";
        for (let i = 0; i < 3; i++) {
          const heart = document.createElement("img");
          heart.src = "images/heart_full.png";
          heart.className = "heart";
          heart.onerror = () => {
            heart.src =
              "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTIwIDRjLTUuNSA0LTEwIDEwLTUuNSAxNGwxMCAxMDEwIDExYy41LTQtNS41LTEwLTUuNS0xNHoiIGZpbGw9IiNmMDBmZiIvPjwvc3ZnPg==";
          };
          elements.hearts.appendChild(heart);
        }
      }

      // Set poses based on fight
      function setPoses() {
        if (gameState.currentFight === 1) {
          // Level 1: First 2 poses/attacks
          gameState.availableAttacks = ["shield", "rocket"];
          gameState.currentPoses = attackPoses
            .slice(0, 2)
            .sort(() => Math.random() - 0.5);
          gameState.numPoses = 2;
        } else {
          // Levels 2-3: All 4
          gameState.availableAttacks = ["shield", "rocket", "sword", "plasma"];
          gameState.currentPoses = [...attackPoses].sort(
            () => Math.random() - 0.5
          );
          gameState.numPoses = 4;
        }
      }

      // Reset to neutral with cooldown delay before next action
      function cooldownToNeutral(delay, callback) {
        setPose(neutralPose);
        disableButtons();
        clearInterval(gameState.timerInterval);
        elements.timerFill.style.width = "100%"; // Reset timer visually
        elements.instruction.textContent = "Cooldown...";
        setTimeout(callback, delay);
      }

      // Start a new fight
      function startFight() {
        if (gameState.currentFight > gameState.maxFights) {
          elements.instruction.textContent = "VICTORY!";
          elements.message.textContent = "Crystal Shattered. Recursion Broken.";
          setPose(neutralPose); // Back to neutral on win
          elements.restart.style.display = "block";
          return;
        }
        setPoses();
        gameState.currentPoseIndex = 0;
        gameState.baseTimerDuration =
          gameState.currentFight === 1
            ? 5000
            : gameState.currentFight === 2
            ? 3000
            : 1500;
        elements.fightInfo.textContent = `Fight: ${gameState.currentFight}/3`;
        elements.instruction.textContent = "Begin!";
        elements.message.textContent = "";
        elements.restart.style.display = "none";
        // Start with neutral, brief pause, then first pose
        setPose(neutralPose);
        setTimeout(() => {
          nextPose();
        }, 500);
      }

      // Show next pose
      function nextPose() {
        if (gameState.currentPoseIndex >= gameState.numPoses) {
          // Fight won - show defeated
          setPose(defeatedPose);
          elements.instruction.textContent = "FIGHT WON!";
          elements.message.textContent = `Fight ${gameState.currentFight} Complete! Rewind...`;
          setTimeout(() => {
            gameState.currentFight++;
            if (gameState.hearts <= 0) {
              gameOver();
            } else {
              startFight();
            }
          }, 2000);
          return;
        }
        const pose = gameState.currentPoses[gameState.currentPoseIndex];
        setPose(pose);
        elements.instruction.textContent = `RESPOND NOW! (${
          gameState.currentPoseIndex + 1
        }/${gameState.numPoses})`;
        elements.message.textContent = pose.desc;
        startTimer();
        enableButtons();
      }

      // Start timer
      function startTimer() {
        if (gameState.isPaused) return;
        clearInterval(gameState.timerInterval);
        const duration = gameState.baseTimerDuration;
        let timeLeft = duration;
        elements.timerFill.style.width = "100%";
        gameState.timerInterval = setInterval(() => {
          if (gameState.isPaused) return;
          timeLeft -= 50;
          const percent = (timeLeft / duration) * 100;
          elements.timerFill.style.width = `${percent}%`;
          if (timeLeft <= 0) {
            clearInterval(gameState.timerInterval);
            loseHeart("Timeout!");
            cooldownToNeutral(1000, nextPose); // Retry after cooldown
          }
        }, 50);
      }

      // Handle attack click
      function handleAttack(action) {
        if (gameState.isPaused || !gameState.availableAttacks.includes(action))
          return;
        clearInterval(gameState.timerInterval);
        const pose = gameState.currentPoses[gameState.currentPoseIndex];
        if (action === pose.correct) {
          elements.instruction.textContent = "PERFECT COUNTER!";
          elements.message.textContent = "Damage dealt!";
          gameState.currentPoseIndex++;
          cooldownToNeutral(500, () => {
            if (gameState.currentPoseIndex >= gameState.numPoses) {
              nextPose(); // This will show defeated
            } else {
              nextPose();
            }
          });
        } else {
          elements.instruction.textContent = "MISSED!";
          elements.message.textContent = "Counter failed!";
          loseHeart();
          cooldownToNeutral(1000, nextPose); // Retry after cooldown
        }
        disableButtons();
      }

      // Lose a heart
      function loseHeart(reason) {
        elements.message.textContent += ` ${reason || "Hit taken."}`;
        gameState.hearts--;
        updateHearts();
        if (gameState.hearts <= 0) {
          setTimeout(gameOver, 1000);
        }
      }

      // Update hearts display
      function updateHearts() {
        const heartEls = elements.hearts.querySelectorAll(".heart");
        heartEls.forEach((el, i) => {
          if (i < gameState.hearts) {
            el.src = "images/heart_full.png";
            el.onerror = () => {
              el.src =
                "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTIwIDRjLTUuNSA0LTEwIDEwLTUuNSAxNGwxMCAxMDEwIDExYy41LTQtNS41LTEwLTUuNS0xNHoiIGZpbGw9IiNmMDBmZiIvPjwvc3ZnPg==";
            };
          } else {
            el.src = "images/heart_empty.png";
            el.onerror = () => {
              el.src =
                "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNmMDAiLz48L3N2Zz4=";
            };
          }
        });
      }

      // Game over
      function gameOver() {
        elements.instruction.textContent = "GAME OVER!";
        elements.message.textContent = "Crystal Overload. Restart?";
        setPose(neutralPose); // Reset to neutral
        elements.restart.style.display = "block";
        disableButtons();
      }

      // Enable/disable buttons based on available attacks
      function enableButtons() {
        elements.attacks.forEach((btn) => {
          if (gameState.availableAttacks.includes(btn.dataset.action)) {
            btn.disabled = false;
          } else {
            btn.disabled = true;
          }
        });
      }
      function disableButtons() {
        elements.attacks.forEach((btn) => (btn.disabled = true));
      }

      // Pause toggle
      function togglePause() {
        gameState.isPaused = !gameState.isPaused;
        elements.pause.textContent = gameState.isPaused ? "Resume" : "Pause";
        elements.timerPaused.style.display = gameState.isPaused
          ? "block"
          : "none";
        if (gameState.isPaused) {
          clearInterval(gameState.timerInterval);
          disableButtons();
          elements.instruction.textContent += " (PAUSED)";
        } else {
          elements.instruction.textContent =
            elements.instruction.textContent.replace(" (PAUSED)", "");
          if (gameState.currentPoseIndex < gameState.numPoses) {
            enableButtons();
            startTimer(); // Resume timer if in pose
          }
        }
      }

      // Event listeners
      elements.startBtn.addEventListener("click", () => {
        elements.titleScreen.style.display = "none";
        elements.game.style.display = "block";
        initHearts();
        startFight();
      });

      elements.htpBtn.addEventListener("click", () => {
        elements.overlay.style.display = "block";
        elements.htp.style.display = "block";
      });

      elements.closeHtp.addEventListener("click", () => {
        elements.overlay.style.display = "none";
        elements.htp.style.display = "none";
      });

      elements.overlay.addEventListener("click", () => {
        elements.overlay.style.display = "none";
        elements.htp.style.display = "none";
      });

      elements.attacks.forEach((btn) => {
        btn.addEventListener("click", () => handleAttack(btn.dataset.action));
      });

      elements.pause.addEventListener("click", togglePause);

      elements.restart.addEventListener("click", () => {
        gameState = {
          ...gameState,
          currentFight: 1,
          hearts: 3,
          currentPoseIndex: 0,
          isPaused: false,
        };
        elements.pause.textContent = "Pause";
        elements.timerPaused.style.display = "none";
        initHearts();
        startFight();
      });

      // Init - Show title
      setPose(neutralPose);
    </script>
  </body>
</html>
